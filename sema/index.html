<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯Ù„Ø§Ù„ÙŠØ© â€” Ø±ÙˆØ§ÙØ¯</title>

  <!-- Ø®Ø· Ø¹Ø±Ø¨ÙŠ Ø¬Ù…ÙŠÙ„ -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="style.css" />

  <!-- d3.js -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
</head>
<body>
  <header>
    <h1>Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø¯Ù„Ø§Ù„ÙŠ â€” <span class="field-name">Ø­Ù‚Ù„ Ø§Ù„Ø«ÙˆØ±Ø©</span> âš¡</h1>
    <div class="controls">
      <button id="download-json">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ JSON</button>
      <button id="export-svg">ğŸ–¼ï¸ ØªØµØ¯ÙŠØ± SVG</button>
      <button id="export-png">ğŸ–¼ï¸ ØªØµØ¯ÙŠØ± PNG</button>
      <a id="example-link" href="#" target="_blank" rel="noopener" style="display:none">Ù…Ø«Ø§Ù„</a>
    </div>
  </header>

  <main>
    <aside id="panel">
      <h2>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø¯Ø©</h2>
      <div id="node-info">
        <p>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¹Ù‚Ø¯Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù‡Ù†Ø§.</p>
      </div>
      <hr/>
      <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø±Ø¶</h3>
      <label>Ø­Ø¬Ù… Ø§Ù„Ø¹Ù‚Ø¯Ø©: <input id="node-size" type="range" min="6" max="28" value="12"></label>
      <label>Ù‚ÙˆØ© Ø§Ù„ØªØ¨Ø§Ø¹Ø¯: <input id="charge" type="range" min="-300" max="0" value="-120"></label>
    </aside>

    <section id="viz-wrap">
      <svg id="viz" preserveAspectRatio="xMidYMid meet"></svg>
    </section>
  </main>

  <footer>
    <small>Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: Ù…Ù„Ù JSON Ù…Ø­Ù„ÙŠ â€” ÙŠÙ…ÙƒÙ† ØªØ­Ø±ÙŠØ±Ù‡ ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„Ù‡.</small>
  </footer>

  <script>
  // --------------------------
  // Ø¥Ø¹Ø¯Ø§Ø¯ Ø¹Ø§Ù…
  // --------------------------
  const svg = d3.select('#viz');
  const width = Math.max(800, window.innerWidth * 0.65);
  const height = Math.max(600, window.innerHeight * 0.75);
  svg.attr('width', width).attr('height', height);

  const colorScale = d3.scaleOrdinal()
    .domain(['core','event','actor','method','emotion','result'])
    .range(['#0b6cff','#ff6b6b','#4ecdc4','#ffd166','#9b5de5','#f77f00']);

  let graphData = null;

  // Ø¹Ù†Ø§ØµØ± DOM
  const info = d3.select('#node-info');
  const downloadJsonBtn = document.getElementById('download-json');
  const exportSvgBtn = document.getElementById('export-svg');
  const exportPngBtn = document.getElementById('export-png');

  // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ù‚ÙˆØ©
  let simulation = d3.forceSimulation()
    .force('link', d3.forceLink().id(d => d.id).distance(120).strength(0.8))
    .force('charge', d3.forceManyBody().strength(-120))
    .force('center', d3.forceCenter(width / 2, height / 2))
    .force('collide', d3.forceCollide().radius(d => (d.size || 12) + 6));

  // ØªØ­Ù…ÙŠÙ„ JSON Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  fetch('data/semantic_fields.json')
    .then(r => r.json())
    .then(json => {
      // Ø§Ø®ØªØ± Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø£ÙˆÙ„ ÙƒÙ…Ø«Ø§Ù„ Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø£Ùˆ Ø­Ù‚Ù„ Ù…Ø­Ø¯Ø¯ "Ø­Ù‚Ù„ Ø§Ù„Ø«ÙˆØ±Ø©"
      const field = (json.fields || []).find(f => f.id === 'revolution') || json.fields[0];
      if (!field) throw new Error('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù‚ÙˆÙ„ ÙÙŠ Ù…Ù„Ù JSON');
      graphData = field;
      d3.select('.field-name').text(field.title);
      renderGraph(field);
      hookButtons(field, json);
    })
    .catch(err => {
      console.error(err);
      info.html('<p style="color:crimson">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ <code>data/semantic_fields.json</code>.</p>');
    });

  // --------------------------
  // Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ù…
  // --------------------------
  function renderGraph(field) {
    svg.selectAll('*').remove();

    const defs = svg.append('defs');

    // shadow filter
    defs.append('filter')
      .attr('id','shadow')
      .append('feDropShadow')
      .attr('dx', 0)
      .attr('dy', 1)
      .attr('stdDeviation', 2)
      .attr('flood-opacity', 0.25);

    const g = svg.append('g');

    const link = g.append('g')
      .attr('class','links')
      .selectAll('line')
      .data(field.links)
      .enter()
      .append('line')
      .attr('stroke','#aaa')
      .attr('stroke-width', d => Math.max(1, d.weight || 1));

    const node = g.append('g')
      .attr('class','nodes')
      .selectAll('g')
      .data(field.nodes)
      .enter()
      .append('g')
      .call(drag(simulation));

    node.append('circle')
      .attr('r', d => d.size || 12)
      .attr('fill', d => colorScale(d.type || 'core'))
      .attr('stroke', '#222')
      .attr('stroke-width', 0.8)
      .attr('filter', 'url(#shadow)')
      .on('click', (event, d) => showInfo(d));

    node.append('text')
      .attr('dy', 4)
      .attr('text-anchor', 'middle')
      .attr('font-family', 'Cairo, sans-serif')
      .attr('font-size', '12px')
      .text(d => d.label);

    // mouseover highlight
    node.on('mouseover', function(event, d) {
      d3.select(this).select('circle').attr('stroke-width', 2.4);
    }).on('mouseout', function() {
      d3.select(this).select('circle').attr('stroke-width', 0.8);
    });

    // zoom
    svg.call(d3.zoom().scaleExtent([0.3, 3]).on('zoom', (event) => {
      g.attr('transform', event.transform);
    }));

    // simulation
    simulation.nodes(field.nodes).on('tick', ticked);
    simulation.force('link').links(field.links);

    function ticked() {
      link
        .attr('x1', d => d.source.x)
        .attr('y1', d => d.source.y)
        .attr('x2', d => d.target.x)
        .attr('y2', d => d.target.y);

      node.attr('transform', d => `translate(${d.x},${d.y})`);
    }

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªØºÙŠØ±Ø©
    document.getElementById('node-size').addEventListener('input', (e) => {
      const val = +e.target.value;
      node.selectAll('circle').attr('r', d => (d.size ? d.size * val/12 : val));
      simulation.force('collide', d3.forceCollide().radius(d => (d.size || val) + 6));
      simulation.alpha(0.5).restart();
    });

    document.getElementById('charge').addEventListener('input', (e) => {
      const val = +e.target.value;
      simulation.force('charge', d3.forceManyBody().strength(val));
      simulation.alpha(0.5).restart();
    });

    // Ø¹Ø±Ø¶ Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ø¹Ù‚Ø¯Ø© Ø§Ù„Ø¬Ø°Ø± (core) Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯Øª
    const core = field.nodes.find(n => n.type === 'core');
    if (core) showInfo(core);
  }

  // --------------------------
  // Ø³Ø­Ø¨ Ø§Ù„Ø¹Ù‚Ø¯
  // --------------------------
  function drag(sim) {
    function dragstarted(event, d) {
      if (!event.active) sim.alphaTarget(0.3).restart();
      d.fx = d.x;
      d.fy = d.y;
    }
    function dragged(event, d) {
      d.fx = event.x;
      d.fy = event.y;
    }
    function dragended(event, d) {
      if (!event.active) sim.alphaTarget(0);
      // ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„ØªØ«Ø¨ÙŠØª Ù„Ø¬Ø¹Ù„ Ø§Ù„Ø¹Ù‚Ø¯ ØªØªØ­Ø±Ùƒ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ (ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø¨Ø§Ù„Ø¶ØºØ· Ù…Ø·ÙˆÙ‘Ù„ Ù„Ùˆ Ø£Ø±Ø¯Øª)
      d.fx = null;
      d.fy = null;
    }
    return d3.drag()
      .on('start', dragstarted)
      .on('drag', dragged)
      .on('end', dragended);
  }

  // --------------------------
  // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯Ø© ÙÙŠ Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„ÙŠÙ…Ù†Ù‰
  // --------------------------
  function showInfo(d) {
    info.html('');
    info.append('h3').text(d.label);
    if (d.type) info.append('p').html(`<strong>Ø§Ù„Ù†ÙˆØ¹:</strong> ${d.type}`);
    if (d.definition) info.append('p').html(`<strong>Ø§Ù„ØªØ¹Ø±ÙŠÙ:</strong> ${d.definition}`);
    if (d.examples && d.examples.length) {
      const ex = info.append('div').attr('class','examples');
      ex.append('strong').text('Ø£Ù…Ø«Ù„Ø©:');
      const ul = ex.append('ul');
      d.examples.forEach(s => ul.append('li').text(s));
    }
    if (d.notes) info.append('p').html(`<em>${d.notes}</em>`);
  }

  // --------------------------
  // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØµØ¯ÙŠØ± ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„
  // --------------------------
  function hookButtons(field, wholeJson) {
    downloadJsonBtn.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(field, null, 2)], {type:'application/json;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = (field.id || 'semantic_field') + '.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    exportSvgBtn.addEventListener('click', () => {
      downloadSVG(svg.node(), (field.id || 'field') + '.svg');
    });

    exportPngBtn.addEventListener('click', () => {
      exportToPNG(svg.node(), (field.id || 'field') + '.png');
    });
  }

  // ØªØ­Ù…ÙŠÙ„ (download) SVG Ù…Ø¨Ø§Ø´Ø±
  function downloadSVG(svgNode, filename) {
    const serializer = new XMLSerializer();
    let source = serializer.serializeToString(svgNode);

    // Ø¥Ø¶Ø§ÙØ© namespace Ø¥Ø°Ø§ Ù„Ø²Ù…
    if(!source.match(/^<svg[^>]+xmlns="http:\/\/www\.w3\.org\/2000\/svg"/)){
      source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
    }
    // Ø¥Ø¶Ø§ÙØ© xml declaration
    source = '<?xml version="1.0" standalone="no"?>\r\n' + source;

    const blob = new Blob([source], {type: 'image/svg+xml;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // ØªØ­ÙˆÙŠÙ„ SVG Ø¥Ù„Ù‰ PNG ÙˆØªÙ†Ø²ÙŠÙ„Ù‡
  function exportToPNG(svgNode, filename) {
    const serializer = new XMLSerializer();
    let source = serializer.serializeToString(svgNode);

    // inline styles to keep fonts & CSS (Ù†ÙØ¶Ù…Ù‘Ù† Ø®Ø· axis style)
    const css = `
      @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');
      svg { font-family: "Cairo", sans-serif; }
    `;
    source = source.replace(/^<svg/, `<svg xmlns="http://www.w3.org/2000/svg"`);
    source = '<?xml version="1.0" standalone="no"?>\n' +
             `<style type="text/css"><![CDATA[${css}]]></style>\n` +
             source;

    const img = new Image();
    const svg64 = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(source);

    img.onload = function() {
      const canvas = document.createElement('canvas');
      canvas.width = svgNode.getAttribute('width') || svgNode.clientWidth || ${width};
      canvas.height = svgNode.getAttribute('height') || svgNode.clientHeight || ${height};
      const ctx = canvas.getContext('2d');

      // Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡ Ù„Ù…Ù†Ø¹ Ø§Ù„Ø´ÙØ§ÙÙŠØ© Ø¥Ø°Ø§ Ø±ØºØ¨Øª
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0,0,canvas.width,canvas.height);

      ctx.drawImage(img, 0, 0);
      canvas.toBlob(function(blob) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }, 'image/png');
    };
    img.onerror = function(e){ alert('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„ØµÙˆØ±Ø©'); console.error(e); };
    img.src = svg64;
  }

  // Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ù†Ø§ÙØ°Ø©
  window.addEventListener('resize', () => {
    const w = Math.max(800, window.innerWidth * 0.65);
    const h = Math.max(600, window.innerHeight * 0.75);
    svg.attr('width', w).attr('height', h);
    simulation.force('center', d3.forceCenter(w/2, h/2));
    simulation.alpha(0.3).restart();
  });

  </script>
</body>
</html>
