<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯Ù„Ø§Ù„ÙŠØ© â€” Ø­Ù‚Ù„ Ø§Ù„Ø«ÙˆØ±Ø©</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#fafafa; --panel:#ffffff; --muted:#666; --accent:#0b6cff;
      font-family: 'Cairo', sans-serif;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#111;font-family:inherit;line-height:1.4}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:linear-gradient(90deg,#fff,#f4f7ff);border-bottom:1px solid #eee}
    header h1{margin:0;font-weight:600;font-size:18px}
    .controls{display:flex;gap:8px;align-items:center}
    .controls button{background:#fff;border:1px solid #ddd;padding:8px 10px;border-radius:8px;cursor:pointer;box-shadow:0 1px 0 rgba(0,0,0,0.03)}
    .controls button:hover{transform:translateY(-1px)}
    main{display:flex;gap:10px;padding:14px;align-items:flex-start}
    #viz-wrap{flex:1;min-height:560px;background:linear-gradient(180deg,#fff,#fbfdff);padding:10px;border-radius:10px;border:1px solid #eee;overflow:hidden}
    footer{padding:12px 18px;color:var(--muted);font-size:13px}
    svg text{pointer-events:none;font-weight:600}
    @media (max-width:900px){ main{flex-direction:column} #viz-wrap{width:100%} }
    pre{white-space:pre-wrap;word-break:break-word;font-size:12px}
  </style>
</head>
<body>
  <header>
    <h1>Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø¯Ù„Ø§Ù„ÙŠ â€” <span class="field-name">...</span> âš¡</h1>
    <div class="controls">
      <button id="export-png">ğŸ–¼ï¸ ØªØµØ¯ÙŠØ± PNG</button>
    </div>
  </header>

  <main>
    <section id="viz-wrap">
      <svg id="viz" preserveAspectRatio="xMidYMid meet"></svg>
    </section>
  </main>

  <footer>
    <small>Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: Ù…Ù„ÙØ§Øª JSON ÙÙŠ /data/hqool/</small>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>

  <script>
(function(){
  const svg = d3.select('#viz');
  let width = Math.max(800, window.innerWidth * 0.65);
  let height = Math.max(600, window.innerHeight * 0.75);
  svg.attr('width', width).attr('height', height);

  const colorScale = d3.scaleOrdinal()
    .domain(['core','event','actor','method','emotion','result'])
    .range(['#0b6cff','#ff6b6b','#4ecdc4','#ffd166','#9b5de5','#f77f00']);

  const exportPngBtn = document.getElementById('export-png');

  let simulation = d3.forceSimulation()
    .force('link', d3.forceLink().id(d => d.id).distance(120).strength(0.8))
    .force('charge', d3.forceManyBody().strength(-120))
    .force('center', d3.forceCenter(width / 2, height / 2))
    .force('collide', d3.forceCollide().radius(d => (d.size || 12) + 6));

  function loadData() {
    const params = new URLSearchParams(window.location.search);
    const id = params.get("i") || "1";
    
    // Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø© Ù„Ù„Ù…Ù„ÙØ§Øª JSON
    const possiblePaths = [
      `data/hqool/${id}.json`,
      `/data/hqool/${id}.json`,
      `./data/hqool/${id}.json`,
      `../data/hqool/${id}.json`
    ];
    
    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ù…Ø³Ø§Ø± Ù…Ø¹ÙŠÙ†
    async function tryLoad(path) {
      try {
        console.log(`Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù†: ${path}`);
        const response = await fetch(path);
        if (!response.ok) {
          throw new Error(`Ø®Ø·Ø£ HTTP: ${response.status}`);
        }
        const data = await response.json();
        console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ Ù…Ù†:', path);
        return data;
      } catch (error) {
        console.log(`ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† ${path}:`, error.message);
        return null;
      }
    }
    
    // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù…ÙƒÙ†Ø© Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨
    return new Promise(async (resolve, reject) => {
      for (const path of possiblePaths) {
        const data = await tryLoad(path);
        if (data) {
          resolve(data);
          return;
        }
      }
      
      // Ø¥Ø°Ø§ ÙˆØµÙ„Ù†Ø§ Ù‡Ù†Ø§ØŒ ÙØ´Ù„Ù†Ø§ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      reject(new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø¬Ù„Ø¯ data/hqool Ù…Ø¹ Ù…Ù„ÙØ§Øª JSON.'));
    });
  }

  // ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  loadData()
    .then(json => {
      console.log('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©:', json);
      
      // ØªØ­Ù‚Ù‚ Ù…Ù† Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      if (!json || typeof json !== 'object') {
        throw new Error('Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©: JSON ÙØ§Ø±Øº Ø£Ùˆ ØºÙŠØ± ØµØ­ÙŠØ­');
      }
      
      // Ø¥Ù…Ø§ Ø£Ù† ÙŠÙƒÙˆÙ† json Ù‡Ùˆ Ø§Ù„Ø­Ù‚Ù„ Ù…Ø¨Ø§Ø´Ø±Ø© Ø£Ùˆ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…ØµÙÙˆÙØ© fields
      let field;
      if (json.fields && Array.isArray(json.fields) && json.fields.length > 0) {
        field = json.fields[0];
      } else if (json.nodes && json.links) {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† json ÙŠØ­ØªÙˆÙŠ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù„Ù‰ nodes Ùˆ links
        field = json;
      } else {
        throw new Error('Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹. ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ nodes Ùˆ links Ø£Ùˆ Ù…ØµÙÙˆÙØ© fields.');
      }
      
      // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø©
      const fieldName = field.title || 'Ø­Ù‚Ù„ ØºÙŠØ± Ù…Ø¹Ù†ÙˆÙ†';
      d3.select('.field-name').text(fieldName);
      
      // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
      if (!field.nodes || !field.links || !Array.isArray(field.nodes) || !Array.isArray(field.links)) {
        throw new Error('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¹Ù‚Ø¯ Ø£Ùˆ Ø±ÙˆØ§Ø¨Ø· ØµØ§Ù„Ø­Ø©');
      }
      
      console.log(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${field.nodes.length} Ø¹Ù‚Ø¯Ø© Ùˆ ${field.links.length} Ø±Ø§Ø¨Ø·`);
      renderGraph(field);
      hookButtons(field);
    })
    .catch(error => {
      console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
      
      // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ ÙÙŠ SVG
      svg.selectAll('*').remove();
      
      svg.append('text')
        .attr('x', width / 2)
        .attr('y', height / 2 - 30)
        .attr('text-anchor', 'middle')
        .attr('dominant-baseline', 'middle')
        .attr('fill', '#ff6b6b')
        .attr('font-size', '18px')
        .text('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
      
      svg.append('text')
        .attr('x', width / 2)
        .attr('y', height / 2)
        .attr('text-anchor', 'middle')
        .attr('dominant-baseline', 'middle')
        .attr('fill', '#666')
        .attr('font-size', '14px')
        .text(error.message || 'ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
      
      svg.append('text')
        .attr('x', width / 2)
        .attr('y', height / 2 + 30)
        .attr('text-anchor', 'middle')
        .attr('dominant-baseline', 'middle')
        .attr('fill', '#888')
        .attr('font-size', '12px')
        .text('ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù„Ù data/hqool/1.json (Ø£Ùˆ i=Ø±Ù‚Ù…_Ø¢Ø®Ø± ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·)');
    });

  function renderGraph(field) {
    svg.selectAll('*').remove();
    const g = svg.append('g');

    // Ø±Ø³Ù… Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
    const link = g.append('g').selectAll('line')
      .data(field.links).enter().append('line')
      .attr('stroke','#aaa')
      .attr('stroke-width', d => Math.max(1, d.weight || 1));

    // Ø±Ø³Ù… Ø§Ù„Ø¹Ù‚Ø¯
    const node = g.append('g').selectAll('g')
      .data(field.nodes).enter().append('g')
      .call(d3.drag()
        .on('start', (e,d)=>{
          if(!e.active) simulation.alphaTarget(0.3).restart();
          d.fx = d.x;
          d.fy = d.y;
        })
        .on('drag', (e,d)=>{
          d.fx = e.x;
          d.fy = e.y;
        })
        .on('end', (e,d)=>{
          if(!e.active) simulation.alphaTarget(0);
          d.fx = null;
          d.fy = null;
        })
      );

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆØ§Ø¦Ø±
    node.append('circle')
      .attr('r', d => d.size || 12)
      .attr('fill', d => colorScale(d.type))
      .attr('stroke','#222')
      .attr('stroke-width',0.8);

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†ØµÙˆØµ
    node.append('text')
      .attr('dy',4)
      .attr('text-anchor','middle')
      .attr('font-size','12px')
      .text(d => d.label);

    // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙƒØ¨ÙŠØ± ÙˆØ§Ù„ØªØ­Ø±ÙŠÙƒ
    svg.call(d3.zoom().scaleExtent([0.3,3]).on('zoom', e=>g.attr('transform',e.transform)));

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©
    simulation.nodes(field.nodes);
    simulation.force('link').links(field.links);
    
    simulation.on('tick', ()=>{
      link.attr('x1', d=>d.source.x)
          .attr('y1', d=>d.source.y)
          .attr('x2', d=>d.target.x)
          .attr('y2', d=>d.target.y);
      node.attr('transform', d=>`translate(${d.x},${d.y})`);
    });

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©
    simulation.alpha(1).restart();
  }

  function hookButtons(field) {
    exportPngBtn.addEventListener('click', () => {
      exportToPNG(svg.node(), (field.id || 'field') + '.png');
    });
  }

  function exportToPNG(svgNode, filename) {
    const serializer = new XMLSerializer();
    let source = serializer.serializeToString(svgNode);
    
    // Ø¥Ø¶Ø§ÙØ© Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡ ÙˆØ¶Ù…Ø§Ù† Ø¹Ø±Ø¶ Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
    const parser = new DOMParser();
    const svgDoc = parser.parseFromString(source, 'image/svg+xml');
    const svgElement = svgDoc.documentElement;
    
    // Ø¥Ø¶Ø§ÙØ© Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡
    const rect = svgDoc.createElementNS('http://www.w3.org/2000/svg', 'rect');
    rect.setAttribute('width', '100%');
    rect.setAttribute('height', '100%');
    rect.setAttribute('fill', '#ffffff');
    svgElement.insertBefore(rect, svgElement.firstChild);
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØµØ¯Ø±
    source = serializer.serializeToString(svgDoc);
    
    const img = new Image();
    const svg64 = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(source);
    img.onload = function() {
      const rect = svgNode.getBoundingClientRect();
      const canvas = document.createElement('canvas');
      canvas.width = rect.width;
      canvas.height = rect.height;
      const ctx = canvas.getContext('2d');
      
      // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø¨ÙŠØ¶
      ctx.fillStyle = '#fff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Ø±Ø³Ù… Ø§Ù„ØµÙˆØ±Ø©
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      
      // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ PNG ÙˆØªÙ†Ø²ÙŠÙ„
      canvas.toBlob(function(blob){
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 'image/png');
    };
    
    img.src = svg64;
  }

  window.addEventListener('resize', () => {
    width = Math.max(800, window.innerWidth * 0.65);
    height = Math.max(600, window.innerHeight * 0.75);
    svg.attr('width', width).attr('height', height);
    simulation.force('center', d3.forceCenter(width/2, height/2));
    simulation.alpha(0.3).restart();
  });

})();
  </script>

</body>
</html>
