<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯Ù„Ø§Ù„ÙŠØ© â€” Ø­Ù‚Ù„ Ø§Ù„Ø«ÙˆØ±Ø©</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#fafafa; --panel:#ffffff; --muted:#666; --accent:#0b6cff;
      font-family: 'Cairo', sans-serif;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#111;font-family:inherit;line-height:1.4}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:linear-gradient(90deg,#fff,#f4f7ff);border-bottom:1px solid #eee}
    header h1{margin:0;font-weight:600;font-size:18px}
    .controls{display:flex;gap:8px;align-items:center}
    .controls button{background:#fff;border:1px solid #ddd;padding:8px 10px;border-radius:8px;cursor:pointer;box-shadow:0 1px 0 rgba(0,0,0,0.03)}
    .controls button:hover{transform:translateY(-1px)}
    main{display:flex;gap:10px;padding:14px;align-items:flex-start}
    #viz-wrap{flex:1;min-height:560px;background:linear-gradient(180deg,#fff,#fbfdff);padding:10px;border-radius:10px;border:1px solid #eee;overflow:hidden}
    footer{padding:12px 18px;color:var(--muted);font-size:13px}
    svg text{pointer-events:none;font-weight:600}
    @media (max-width:900px){ main{flex-direction:column} #viz-wrap{width:100%} }
    pre{white-space:pre-wrap;word-break:break-word;font-size:12px}
  </style>
</head>
<body>
  <header>
    <h1>Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø¯Ù„Ø§Ù„ÙŠ â€” <span class="field-name">...</span> âš¡</h1>
    <div class="controls">
      <button id="export-png">ğŸ–¼ï¸ ØªØµØ¯ÙŠØ± PNG</button>
    </div>
  </header>

  <main>
    <section id="viz-wrap">
      <svg id="viz" preserveAspectRatio="xMidYMid meet"></svg>
    </section>
  </main>

  <footer>
    <small>Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: Ù…Ù„ÙØ§Øª JSON ÙÙŠ /data/hqool/</small>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>

 <script>
(function(){
  const svg = d3.select('#viz');
  let width = Math.max(800, window.innerWidth * 0.65);
  let height = Math.max(600, window.innerHeight * 0.75);
  svg.attr('width', width).attr('height', height);

  const colorScale = d3.scaleOrdinal()
    .domain(['core','event','actor','method','emotion','result'])
    .range(['#0b6cff','#ff6b6b','#4ecdc4','#ffd166','#9b5de5','#f77f00']);

  const exportPngBtn = document.getElementById('export-png');

  let simulation = d3.forceSimulation()
    .force('link', d3.forceLink().id(d => d.id).distance(120).strength(0.8))
    .force('charge', d3.forceManyBody().strength(-120))
    .force('center', d3.forceCenter(width / 2, height / 2))
    .force('collide', d3.forceCollide().radius(d => (d.size || 12) + 6));

  async function loadData() {
    const params = new URLSearchParams(window.location.search);
    const id = params.get("i") || "1";

    // Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø³Ø§Ø±Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø© Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø¨ÙŠØ¦Ø§Øª Ù…Ø®ØªÙ„ÙØ©
    const possiblePaths = [
      `data/hqool/${id}.json`,                // Ù„Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù†Ø³Ø¨ÙŠ
      `/data/hqool/${id}.json`,               // Ù„Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø·Ù„Ù‚ Ù…Ù† Ø§Ù„Ø¬Ø°Ø±
      `./data/hqool/${id}.json`,              // Ù„Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
      `../data/hqool/${id}.json`              // Ù„Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰
    ];

    let data = null;
    let error = null;

    // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù…ÙƒÙ†Ø©
    for (const path of possiblePaths) {
      try {
        console.log(`Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù†: ${path}`);
        const response = await fetch(path);
        
        if (response.ok) {
          data = await response.json();
          console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­:', data);
          break;
        }
      } catch (err) {
        error = err;
        console.warn(`ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† ${path}:`, err);
      }
    }

    if (!data) {
      // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³Ø§Ø±Ø§ØªØŒ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£
      console.error('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø£ÙŠ Ù…Ø³Ø§Ø±:', error);
      throw new Error('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    }

    return data;
  }

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¹Ø±Ø¶Ù‡Ø§
  loadData()
    .then(json => {
      const field = (json.fields || [])[0];
      const fieldName = field?.title || 'Ø­Ù‚Ù„';
      d3.select('.field-name').text(fieldName);
      document.title = `Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯Ù„Ø§Ù„ÙŠØ© â€” ${fieldName}`;

      if (!field || !field.nodes || !field.links) {
        svg.append('text')
           .attr('x', width/2)
           .attr('y', height/2)
           .attr('text-anchor','middle')
           .attr('dominant-baseline','middle')
           .attr('fill', '#666')
           .text('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø±Ø³Ù…');
        return;
      }

      renderGraph(field);
      hookButtons(field);
    })
    .catch(error => {
      console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
      svg.append('text')
         .attr('x', width/2)
         .attr('y', height/2 - 20)
         .attr('text-anchor','middle')
         .attr('dominant-baseline','middle')
         .attr('fill', '#ff6b6b')
         .text('âŒ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
      
      svg.append('text')
         .attr('x', width/2)
         .attr('y', height/2 + 20)
         .attr('text-anchor','middle')
         .attr('dominant-baseline','middle')
         .attr('fill', '#666')
         .attr('font-size', '12px')
         .text('ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù„ÙØ§Øª JSON ÙÙŠ Ù…Ø¬Ù„Ø¯ /data/hqool/');
    });

  function renderGraph(field) {
    console.log('Ø±Ø³Ù… Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ:', field.nodes?.length, 'Ø¹Ù‚Ø¯ØŒ', field.links?.length, 'Ø±ÙˆØ§Ø¨Ø·');
    
    svg.selectAll('*').remove();
    const g = svg.append('g');

    // Ø±Ø³Ù… Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
    const link = g.append('g')
      .selectAll('line')
      .data(field.links)
      .enter()
      .append('line')
      .attr('stroke', '#aaa')
      .attr('stroke-width', d => Math.max(1, d.weight || 1))
      .attr('stroke-opacity', 0.6);

    // Ø±Ø³Ù… Ø§Ù„Ø¹Ù‚Ø¯
    const node = g.append('g')
      .selectAll('g')
      .data(field.nodes)
      .enter()
      .append('g')
      .call(d3.drag()
        .on('start', (e, d) => {
          if (!e.active) simulation.alphaTarget(0.3).restart();
          d.fx = d.x;
          d.fy = d.y;
        })
        .on('drag', (e, d) => {
          d.fx = e.x;
          d.fy = e.y;
        })
        .on('end', (e, d) => {
          if (!e.active) simulation.alphaTarget(0);
          d.fx = null;
          d.fy = null;
        })
      );

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆØ§Ø¦Ø±
    node.append('circle')
      .attr('r', d => d.size || 12)
      .attr('fill', d => colorScale(d.type))
      .attr('stroke', '#fff')
      .attr('stroke-width', 2)
      .attr('stroke-opacity', 0.8);

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†ØµÙˆØµ
    node.append('text')
      .attr('dy', 4)
      .attr('text-anchor', 'middle')
      .attr('font-size', '11px')
      .attr('font-weight', '600')
      .attr('fill', '#222')
      .attr('paint-order', 'stroke')
      .attr('stroke', '#fff')
      .attr('stroke-width', '3px')
      .attr('stroke-linecap', 'round')
      .attr('stroke-linejoin', 'round')
      .text(d => d.label);

    // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙƒØ¨ÙŠØ± ÙˆØ§Ù„ØªØµØºÙŠØ±
    svg.call(d3.zoom()
      .scaleExtent([0.3, 3])
      .on('zoom', e => g.attr('transform', e.transform))
    );

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©
    simulation.nodes(field.nodes);
    simulation.force('link').links(field.links);
    
    simulation.on('tick', () => {
      link.attr('x1', d => d.source.x)
          .attr('y1', d => d.source.y)
          .attr('x2', d => d.target.x)
          .attr('y2', d => d.target.y);
      
      node.attr('transform', d => `translate(${d.x},${d.y})`);
    });

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©
    simulation.alpha(1).restart();
  }

  function hookButtons(field) {
    exportPngBtn.addEventListener('click', () => {
      exportToPNG(svg.node(), (field.id || 'field') + '.png');
    });
  }

  function exportToPNG(svgNode, filename) {
    const serializer = new XMLSerializer();
    const source = serializer.serializeToString(svgNode);
    
    // Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØ±Ø© Ù…Ù† SVG
    const img = new Image();
    const svg64 = btoa(unescape(encodeURIComponent(source)));
    const b64Start = 'data:image/svg+xml;base64,';
    
    img.onload = function() {
      const canvas = document.createElement('canvas');
      canvas.width = svgNode.getBoundingClientRect().width;
      canvas.height = svgNode.getBoundingClientRect().height;
      
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#fff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0);
      
      // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ PNG ÙˆØªÙ†Ø²ÙŠÙ„
      canvas.toBlob(function(blob) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 'image/png');
    };
    
    img.src = b64Start + svg64;
  }

  window.addEventListener('resize', () => {
    width = Math.max(800, window.innerWidth * 0.65);
    height = Math.max(600, window.innerHeight * 0.75);
    svg.attr('width', width).attr('height', height);
    simulation.force('center', d3.forceCenter(width/2, height/2));
    simulation.alpha(0.3).restart();
  });

})();
</script>
</body>
</html>
