<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯Ù„Ø§Ù„ÙŠØ© â€” Ø­Ù‚Ù„ Ø§Ù„Ø«ÙˆØ±Ø©</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#fafafa; --panel:#ffffff; --muted:#666; --accent:#0b6cff;
      font-family: 'Cairo', sans-serif;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#111;font-family:inherit;line-height:1.4}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:linear-gradient(90deg,#fff,#f4f7ff);border-bottom:1px solid #eee}
    header h1{margin:0;font-weight:600;font-size:18px}
    .controls{display:flex;gap:8px;align-items:center}
    .controls button{background:#fff;border:1px solid #ddd;padding:8px 10px;border-radius:8px;cursor:pointer;box-shadow:0 1px 0 rgba(0,0,0,0.03)}
    .controls button:hover{transform:translateY(-1px)}
    main{display:flex;gap:10px;padding:14px;align-items:flex-start}
    #panel{width:300px;background:var(--panel);padding:14px;border-radius:10px;border:1px solid #eee;box-shadow:0 6px 20px rgba(38,50,56,0.04)}
    #panel h2{margin-top:0}
    #panel p{color:var(--muted)}
    #viz-wrap{flex:1;min-height:560px;background:linear-gradient(180deg,#fff,#fbfdff);padding:10px;border-radius:10px;border:1px solid #eee;overflow:hidden}
    footer{padding:12px 18px;color:var(--muted);font-size:13px}
    svg text{pointer-events:none;font-weight:600}
    @media (max-width:900px){ main{flex-direction:column} #panel{width:100%} #viz-wrap{width:100%} }
    /* Ø¨Ø³ÙŠØ· Ù„Ø¹Ø±Ø¶ Ø±ÙˆØ§Ø¨Ø· JSON Ø§Ù„Ù…Ø¯Ù…Ø¬ */
    pre{white-space:pre-wrap;word-break:break-word;font-size:12px}
  </style>
</head>
<body>
  <header>
    <h1>Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø¯Ù„Ø§Ù„ÙŠ â€” <span class="field-name">Ø­Ù‚Ù„ Ø§Ù„Ø«ÙˆØ±Ø©</span> âš¡</h1>
    <div class="controls">
      <button id="download-json">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ JSON</button>
      <button id="export-svg">ğŸ–¼ï¸ ØªØµØ¯ÙŠØ± SVG</button>
      <button id="export-png">ğŸ–¼ï¸ ØªØµØ¯ÙŠØ± PNG</button>
    </div>
  </header>

  <main>
    <aside id="panel">
      <h2>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø¯Ø©</h2>
      <div id="node-info"><p>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¹Ù‚Ø¯Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù‡Ù†Ø§.</p></div>
      <hr/>
      <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø±Ø¶</h3>
      <label>Ø­Ø¬Ù… Ø§Ù„Ø¹Ù‚Ø¯Ø©: <input id="node-size" type="range" min="6" max="28" value="12"></label><br/>
      <label>Ù‚ÙˆØ© Ø§Ù„ØªØ¨Ø§Ø¹Ø¯: <input id="charge" type="range" min="-300" max="0" value="-120"></label>
      <hr/>
      <p style="color:var(--muted)">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ø°Ø§ Ù„Ù… ØªÙ‚Ù… Ø¨Ø±ÙØ¹ Ù…Ù„Ù <code>data/semantic_fields.json</code> Ø³ÙŠØ¹Ù…Ù„ Ø§Ù„Ù…Ø«Ø§Ù„ Ø§Ù„Ù…Ø¶Ù…Ù‘Ù†.</p>
    </aside>

    <section id="viz-wrap">
      <svg id="viz" preserveAspectRatio="xMidYMid meet"></svg>
    </section>
  </main>

  <footer>
    <small>Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: Ù…Ù„Ù JSON Ù…Ø­Ù„ÙŠ Ø£Ùˆ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¶Ù…Ù‘Ù†Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø©.</small>
  </footer>

  <!-- Ù†Ø³Ø®Ø© JSON Ù…Ø¶Ù…Ù‘Ù†Ø© ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© -->
  <script id="embedded-data" type="application/json">
  {
    "fields": [
      {
        "id":"revolution",
        "title":"Ø­Ù‚Ù„ Ø§Ù„Ø«ÙˆØ±Ø©",
        "description":"Ù…ÙØ§Ù‡ÙŠÙ… ÙˆÙƒÙ„Ù…Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ø«ÙˆØ±Ø© Ø¨Ù…Ø³ØªÙˆÙŠØ§Øª Ù…ØªØ¹Ø¯Ø¯Ø© (Ø£Ø­Ø¯Ø§Ø«ØŒ ÙØ§Ø¹Ù„ÙŠÙ†ØŒ Ù†ØªØ§Ø¦Ø¬ØŒ Ù…Ø´Ø§Ø¹Ø±ØŒ Ø·Ø±Ù‚).",
        "nodes":[
          {"id":"Ø«ÙˆØ±Ø©","label":"Ø«ÙˆØ±Ø©","type":"core","size":18,"definition":"Ø­Ø±ÙƒØ© Ø¬Ù…Ø§Ù‡ÙŠØ±ÙŠØ© ØªÙ‡Ø¯Ù Ø¥Ù„Ù‰ ØªØºÙŠÙŠØ± Ù†Ø¸Ø§Ù… Ø³ÙŠØ§Ø³ÙŠ Ø£Ùˆ Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ.","examples":["Ø«ÙˆØ±Ø© Ø³Ù„Ù…ÙŠØ© Ù†Ø§Ø¬Ø­Ø©","Ø§Ù†Ø·Ù„Ù‚Øª Ø§Ù„Ø«ÙˆØ±Ø© ÙÙŠ Ø§Ù„ØµØ¨Ø§Ø­"]},
          {"id":"Ø§Ø­ØªØ¬Ø§Ø¬","label":"Ø§Ø­ØªØ¬Ø§Ø¬","type":"event","size":12,"definition":"ØªØ¹Ø¨ÙŠØ± Ø¬Ù…Ø§Ø¹ÙŠ Ø¹Ù† Ø±ÙØ¶ Ø£Ùˆ Ù…Ø·Ø§Ù„Ø¨Ø©.","examples":["Ù†Ø¸Ù…ÙˆØ§ Ø§Ø­ØªØ¬Ø§Ø¬Ù‹Ø§ Ø£Ù…Ø§Ù… Ø§Ù„Ø¨Ø±Ù„Ù…Ø§Ù†"]},
          {"id":"Ø§Ù†ØªÙØ§Ø¶Ø©","label":"Ø§Ù†ØªÙØ§Ø¶Ø©","type":"event","size":12,"definition":"Ø§Ù†Ø¯Ù„Ø§Ø¹ Ø´Ø¹Ø¨ÙŠ Ø¹Ø§Ø¯Ø© Ø¨Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§Ø³Ø¹Ø©.","examples":["Ø´Ù‡Ø¯Øª Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù†ØªÙØ§Ø¶Ø© Ø¹Ø§Ø±Ù…Ø©"]},
          {"id":"Ø¥ØµÙ„Ø§Ø­","label":"Ø¥ØµÙ„Ø§Ø­","type":"result","size":12,"definition":"ØªØºÙŠÙŠØ± ØªØ¯Ø±ÙŠØ¬ÙŠ ÙÙŠ Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª Ø£Ùˆ Ø§Ù„Ù‚ÙˆØ§Ù†ÙŠÙ†.","examples":["Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙƒØ§Ù†Øª ÙˆØ¹Ø¯Ù‹Ø§ Ø¨Ø§Ù„Ø¥ØµÙ„Ø§Ø­"]},
          {"id":"Ø¥Ø¶Ø±Ø§Ø¨","label":"Ø¥Ø¶Ø±Ø§Ø¨","type":"method","size":12,"definition":"Ø§Ù…ØªÙ†Ø§Ø¹ Ù…Ù†Ø¸Ù… Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„ Ù„Ù„Ø§Ø­ØªØ¬Ø§Ø¬.","examples":["Ø£Ø¹Ù„Ù† Ø§Ù„Ø¹Ù…Ø§Ù„ Ø¥Ø¶Ø±Ø§Ø¨Ù‹Ø§ Ø¹Ø§Ù…Ù‹Ø§"]},
          {"id":"Ù‚Ù…Ø¹","label":"Ù‚Ù…Ø¹","type":"actor","size":12,"definition":"Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ù„Ø·ÙˆÙŠØ© Ù„ÙƒØ¨Ø­ Ø§Ù„Ø­Ø±ÙƒØ©.","examples":["ØªØ¹Ø±Ø¶ Ø§Ù„Ù…ØªØ¸Ø§Ù‡Ø±ÙˆÙ† Ù„Ù‚Ù…Ø¹ Ø´Ø¯ÙŠØ¯"]},
          {"id":"Ø³Ù„Ù…ÙŠØ©","label":"Ø³Ù„Ù…ÙŠØ©","type":"method","size":11,"definition":"Ù†Ù‡Ø¬ Ù…Ù† Ø¯ÙˆÙ† Ø¹Ù†Ù.","examples":["Ø§Ù„Ù…Ø¸Ø§Ù‡Ø±Ø§Øª ÙƒØ§Ù†Øª Ø³Ù„Ù…ÙŠØ©"]},
          {"id":"Ø¹Ù†Ù","label":"Ø¹Ù†Ù","type":"emotion","size":11,"definition":"ØªØµØ§Ø¹Ø¯ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙˆØ©ØŒ ØºØ§Ù„Ø¨Ù‹Ø§ Ù†ØªÙŠØ¬Ø© ØªØµØ¹ÙŠØ¯.","examples":["ØªØ­ÙˆÙ„Øª Ø§Ù„Ø§Ø­ØªØ¬Ø§Ø¬Ø§Øª Ø¥Ù„Ù‰ Ø¹Ù†Ù"]},
          {"id":"ØªØºÙŠÙŠØ±","label":"ØªØºÙŠÙŠØ±","type":"result","size":12,"definition":"ØªØ­ÙˆÙ„ ÙÙŠ Ø¨Ù†Ù‰ Ø§Ù„Ø­ÙƒÙ… Ø£Ùˆ Ø§Ù„Ù‚ÙŠÙ….","examples":["Ø·Ø§Ù„Ø¨ÙˆØ§ Ø¨ØªØºÙŠÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…"]},
          {"id":"Ø´Ø¹Ø¨","label":"Ø§Ù„Ø´Ø¹Ø¨","type":"actor","size":13,"definition":"Ø§Ù„Ø·Ø¨Ù‚Ø© Ø£Ùˆ Ø§Ù„Ø¬Ù…Ø§Ù‡ÙŠØ± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©.","examples":["Ø§Ù„Ø´Ø¹Ø¨ ÙˆÙ‚Ù Ù…ÙˆØ­Ø¯Ù‹Ø§"]},
          {"id":"Ù‚Ø§Ø¦Ø¯","label":"Ù‚Ø§Ø¦Ø¯","type":"actor","size":11,"definition":"Ø´Ø®Øµ ÙŠÙ‚ÙˆØ¯ Ø£Ùˆ ÙŠÙˆØ¬Ù‘Ù‡ Ø§Ù„Ø­Ø±ÙƒØ©.","examples":["Ø¸Ù‡Ø± Ù‚Ø§Ø¦Ø¯ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø­Ø±Ø§Ùƒ"]},
          {"id":"Ø´Ø¨ÙƒØ§Øª_Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©","label":"Ø´Ø¨ÙƒØ§Øª Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©","type":"method","size":11,"definition":"Ù…Ù†ØµØ§Øª ØªØ³Ø§Ø¹Ø¯ ÙÙŠ Ø§Ù„ØªÙ†Ø¸ÙŠÙ…","examples":["Ù†ÙØ¸Ù…Øª Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ø¹Ø¨Ø± Ø§Ù„Ø´Ø¨ÙƒØ§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©"]},
          {"id":"Ù…Ù‚Ø§ÙˆÙ…Ø©","label":"Ù…Ù‚Ø§ÙˆÙ…Ø©","type":"emotion","size":11,"definition":"Ø±ÙØ¶ ÙˆØ§Ø³ØªØ¨Ø³Ø§Ù„ Ø¶Ø¯ Ø§Ù„Ø¸Ù„Ù…","examples":["Ø£Ø¨Ø¯Ù‰ Ø§Ù„Ù…Ø¯Ù†ÙŠÙˆÙ† Ù…Ù‚Ø§ÙˆÙ…Ø©Ù‹ Ù…Ø³ØªÙ…Ø±Ø©"]}
        ],
        "links":[
          {"source":"Ø«ÙˆØ±Ø©","target":"Ø´Ø¹Ø¨","weight":2},
          {"source":"Ø«ÙˆØ±Ø©","target":"Ù‚Ø§Ø¦Ø¯","weight":1},
          {"source":"Ø´Ø¹Ø¨","target":"Ø§Ø­ØªØ¬Ø§Ø¬","weight":2},
          {"source":"Ø§Ø­ØªØ¬Ø§Ø¬","target":"Ø¥Ø¶Ø±Ø§Ø¨","weight":1},
          {"source":"Ø§Ø­ØªØ¬Ø§Ø¬","target":"Ø§Ù†ØªÙØ§Ø¶Ø©","weight":2},
          {"source":"Ø§Ù†ØªÙØ§Ø¶Ø©","target":"Ù‚Ù…Ø¹","weight":2},
          {"source":"Ù‚Ù…Ø¹","target":"Ø¹Ù†Ù","weight":2},
          {"source":"Ø³Ù„Ù…ÙŠØ©","target":"Ø§Ø­ØªØ¬Ø§Ø¬","weight":1},
          {"source":"Ø´Ø¨ÙƒØ§Øª_Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©","target":"Ø§Ø­ØªØ¬Ø§Ø¬","weight":1},
          {"source":"Ù…Ù‚Ø§ÙˆÙ…Ø©","target":"Ø´Ø¹Ø¨","weight":1},
          {"source":"ØªØºÙŠÙŠØ±","target":"Ø¥ØµÙ„Ø§Ø­","weight":1},
          {"source":"Ø«ÙˆØ±Ø©","target":"ØªØºÙŠÙŠØ±","weight":2},
          {"source":"Ù‚Ø§Ø¦Ø¯","target":"Ø´Ø¨ÙƒØ§Øª_Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©","weight":1}
        ]
      }
    ]
  }
  </script>

  <!-- d3 -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>

  <script>
  (function(){
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£ÙˆÙ„ÙŠØ©
    const svg = d3.select('#viz');
    let width = Math.max(800, window.innerWidth * 0.65);
    let height = Math.max(600, window.innerHeight * 0.75);
    svg.attr('width', width).attr('height', height);

    const colorScale = d3.scaleOrdinal()
      .domain(['core','event','actor','method','emotion','result'])
      .range(['#0b6cff','#ff6b6b','#4ecdc4','#ffd166','#9b5de5','#f77f00']);

    const info = d3.select('#node-info');
    const downloadJsonBtn = document.getElementById('download-json');
    const exportSvgBtn = document.getElementById('export-svg');
    const exportPngBtn = document.getElementById('export-png');

    let simulation = d3.forceSimulation()
      .force('link', d3.forceLink().id(d => d.id).distance(120).strength(0.8))
      .force('charge', d3.forceManyBody().strength(-120))
      .force('center', d3.forceCenter(width / 2, height / 2))
      .force('collide', d3.forceCollide().radius(d => (d.size || 12) + 6));

    // Ø­Ø§ÙˆÙ„ Ø¬Ù„Ø¨ JSON Ø®Ø§Ø±Ø¬ÙŠ Ø«Ù… Ø§Ù„ÙˆÙ‚ÙˆØ¹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¶Ù…Ù‘Ù† Ø¥Ø°Ø§ ÙØ´Ù„
    function loadData() {
      return fetch('./data/semantic_fields.json')
        .then(r => {
          if (!r.ok) throw new Error('HTTP ' + r.status);
          return r.json();
        })
        .catch(err => {
          console.warn('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ data/semantic_fields.json â€” Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¶Ù…Ù‘Ù†Ø©. ('+err.message+')');
          const embedded = document.getElementById('embedded-data').textContent.trim();
          try { return JSON.parse(embedded); }
          catch(e){ throw new Error('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª JSON'); }
        });
    }

    loadData().then(json => {
      console.log('JSON loaded', json);
      const field = (json.fields || []).find(f => f.id === 'revolution') || json.fields[0];
      if (!field) throw new Error('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù‚ÙˆÙ„ ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª JSON');
      d3.select('.field-name').text(field.title || 'Ø­Ù‚Ù„');
      renderGraph(field);
      hookButtons(field);
    }).catch(err => {
      console.error(err);
      info.html('<p style="color:crimson">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + (err.message || '') + '</p>');
    });

    // Ø±Ø³Ù… Ø§Ù„Ø´Ø¨ÙƒØ©
    function renderGraph(field) {
      svg.selectAll('*').remove();
      // ØªØ­Ø¯ÙŠØ« Ø£Ø¨Ø¹Ø§Ø¯
      width = Math.max(800, window.innerWidth * 0.65);
      height = Math.max(600, window.innerHeight * 0.75);
      svg.attr('width', width).attr('height', height);
      simulation.force('center', d3.forceCenter(width / 2, height / 2));

      const defs = svg.append('defs');
      defs.append('filter').attr('id','shadow').append('feDropShadow').attr('dx',0).attr('dy',1).attr('stdDeviation',2).attr('flood-opacity',0.25);

      const g = svg.append('g');

      const link = g.append('g').attr('class','links').selectAll('line')
        .data(field.links)
        .enter()
        .append('line')
        .attr('stroke','#aaa')
        .attr('stroke-width', d => Math.max(1, d.weight || 1));

      const node = g.append('g').attr('class','nodes').selectAll('g')
        .data(field.nodes)
        .enter()
        .append('g')
        .call(d3.drag()
          .on('start', (event, d) => {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x; d.fy = d.y;
          })
          .on('drag', (event, d) => { d.fx = event.x; d.fy = event.y; })
          .on('end', (event, d) => {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null; d.fy = null;
          })
        );

      node.append('circle')
        .attr('r', d => d.size || 12)
        .attr('fill', d => colorScale(d.type || 'core'))
        .attr('stroke', '#222')
        .attr('stroke-width', 0.8)
        .attr('filter', 'url(#shadow)')
        .on('click', (event, d) => showInfo(d));

      node.append('text')
        .attr('dy', 4)
        .attr('text-anchor', 'middle')
        .attr('font-family', 'Cairo, sans-serif')
        .attr('font-size', '12px')
        .text(d => d.label);

      node.on('mouseover', function() { d3.select(this).select('circle').attr('stroke-width', 2.4); })
          .on('mouseout', function() { d3.select(this).select('circle').attr('stroke-width', 0.8); });

      svg.call(d3.zoom().scaleExtent([0.3,3]).on('zoom', (event) => { g.attr('transform', event.transform); }));

      simulation.nodes(field.nodes).on('tick', ticked);
      simulation.force('link').links(field.links);

      function ticked() {
        link.attr('x1', d => d.source.x)
            .attr('y1', d => d.source.y)
            .attr('x2', d => d.target.x)
            .attr('y2', d => d.target.y);
        node.attr('transform', d => `translate(${d.x},${d.y})`);
      }

      // ØªØ­ÙƒÙ…Ø§Øª ÙˆØ§Ø¬Ù‡Ø©
      document.getElementById('node-size').addEventListener('input', (e) => {
        const val = +e.target.value;
        node.selectAll('circle').attr('r', d => (d.size ? d.size * val/12 : val));
        simulation.force('collide', d3.forceCollide().radius(d => (d.size || val) + 6));
        simulation.alpha(0.5).restart();
      });

      document.getElementById('charge').addEventListener('input', (e) => {
        const val = +e.target.value;
        simulation.force('charge', d3.forceManyBody().strength(val));
        simulation.alpha(0.5).restart();
      });

      // Ø¹Ø±Ø¶ Ø£ÙˆÙ„ÙŠ Ù„Ø¹Ù‚Ø¯Ø© core Ø¥Ù† ÙˆÙØ¬Ø¯Øª
      const core = field.nodes.find(n => n.type === 'core');
      if (core) showInfo(core);
    }

    function showInfo(d) {
      info.html('');
      info.append('h3').text(d.label);
      if (d.type) info.append('p').html(`<strong>Ø§Ù„Ù†ÙˆØ¹:</strong> ${d.type}`);
      if (d.definition) info.append('p').html(`<strong>Ø§Ù„ØªØ¹Ø±ÙŠÙ:</strong> ${d.definition}`);
      if (d.examples && d.examples.length) {
        const ex = info.append('div').attr('class','examples');
        ex.append('strong').text('Ø£Ù…Ø«Ù„Ø©:');
        const ul = ex.append('ul');
        d.examples.forEach(s => ul.append('li').text(s));
      }
      if (d.notes) info.append('p').html(`<em>${d.notes}</em>`);
    }

    // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØµØ¯ÙŠØ± ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„
    function hookButtons(field) {
      downloadJsonBtn.addEventListener('click', () => {
        const blob = new Blob([JSON.stringify(field, null, 2)], {type:'application/json;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = (field.id || 'semantic_field') + '.json';
        document.body.appendChild(a);
        a.click(); a.remove(); URL.revokeObjectURL(url);
      });

      exportSvgBtn.addEventListener('click', () => {
        downloadSVG(svg.node(), (field.id || 'field') + '.svg');
      });

      exportPngBtn.addEventListener('click', () => {
        exportToPNG(svg.node(), (field.id || 'field') + '.png');
      });
    }

    // ØªØ­Ù…ÙŠÙ„ SVG
    function downloadSVG(svgNode, filename) {
      const serializer = new XMLSerializer();
      let source = serializer.serializeToString(svgNode);
      if(!source.match(/^<svg[^>]+xmlns="http:\/\/www\.w3\.org\/2000\/svg"/)){
        source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
      }
      source = '<?xml version="1.0" standalone="no"?>\r\n' + source;
      const blob = new Blob([source], {type: 'image/svg+xml;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // ØªØ­ÙˆÙŠÙ„ SVG Ø¥Ù„Ù‰ PNG
    function exportToPNG(svgNode, filename) {
      const serializer = new XMLSerializer();
      let source = serializer.serializeToString(svgNode);
      const css = "@import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap'); svg{font-family:Cairo, sans-serif}";
      if(!source.match(/^<svg[^>]+xmlns="http:\/\/www\.w3\.org\/2000\/svg"/)){
        source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
      }
      source = '<?xml version="1.0" standalone="no"?>\n' +
               `<style type="text/css"><![CDATA[${css}]]></style>\n` +
               source;
      const img = new Image();
      const svg64 = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(source);
      img.onload = function() {
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ø¨Ø¹Ø§Ø¯ ÙØ¹Ù„ÙŠØ© Ù„Ù„Ù€ SVG
        const svgRect = svgNode.getBoundingClientRect();
        const canvas = document.createElement('canvas');
        canvas.width = Math.max(1, Math.round(svgRect.width));
        canvas.height = Math.max(1, Math.round(svgRect.height));
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        canvas.toBlob(function(blob) {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        }, 'image/png');
      };
      img.onerror = function(e){ alert('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„ØµÙˆØ±Ø© â€” Ø±Ø§Ø¬Ø¹ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„'); console.error(e); };
      img.src = svg64;
    }

    // Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ù†Ø§ÙØ°Ø©
    window.addEventListener('resize', () => {
      width = Math.max(800, window.innerWidth * 0.65);
      height = Math.max(600, window.innerHeight * 0.75);
      svg.attr('width', width).attr('height', height);
      simulation.force('center', d3.forceCenter(width/2, height/2));
      simulation.alpha(0.3).restart();
    });

  })();
  </script>
</body>
</html>
