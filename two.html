<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø¨ÙŠÙ† - Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯Ù„Ø§Ù„ÙŠØ©</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#fafafa; --panel:#ffffff; --muted:#666; --accent:#0b6cff;
      font-family: 'Cairo', sans-serif;
    }
    
    * {
      box-sizing: border-box;
      font-family: 'Cairo', sans-serif;
    }
    
    body {
      margin: 0;
      background-color: #fff;
      color: #111;
      font-family: 'Cairo', sans-serif;
      line-height: 1.4;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    
    /* ğŸ”¹ Ø§Ù„ØªÙˆØ¨ Ø¨Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
    header {
      background-color: #0e6666;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 25px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    
    header img {
      height: 45px;
      border-radius: 10px;
    }
    
    header h1 {
      font-size: 20px;
      color: #004f4f;
      margin: 0;
      font-weight: 700;
    }
    
    /* ğŸ”¹ Ø§Ù„ÙÙˆØªØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
    footer {
      background-color: #eafafa;
      border-top: 2px solid #4fc3c3;
      padding: 20px;
      text-align: center;
      margin-top: auto;
    }
    
    footer a {
      color: #007b7b;
      text-decoration: none;
      margin: 0 10px;
      font-weight: 600;
    }
    
    footer a:hover {
      text-decoration: underline;
    }
    
    /* Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
    .container {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
      padding: 0 15px;
    }
    
    /* Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 0;
      background: linear-gradient(90deg, #fff, #f4f7ff);
      border-bottom: 1px solid #eee;
      margin-top: 15px;
      border-radius: 10px 10px 0 0;
    }
    
    .page-header h1 {
      margin: 0;
      font-weight: 600;
      font-size: 18px;
      color: #0e6666;
    }
    
    .controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .controls button {
      background: #fff;
      border: 1px solid #ddd;
      padding: 8px 10px;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 1px 0 rgba(0,0,0,0.03);
      font-family: 'Cairo', sans-serif;
      font-weight: 600;
      color: #0e6666;
      transition: all 0.3s;
    }
    
    .controls button:hover {
      transform: translateY(-1px);
      background-color: #4fc3c3;
      color: white;
    }
    
    main {
      flex: 1;
      display: flex;
      gap: 10px;
      padding: 14px 0;
      align-items: flex-start;
    }
    
    #viz-wrap {
      flex: 1;
      min-height: 560px;
      background: linear-gradient(180deg, #fff, #fbfdff);
      padding: 15px;
      border-radius: 0 0 10px 10px;
      border: 1px solid #eee;
      overflow: hidden;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    }
    
    svg text {
      pointer-events: none;
      font-weight: 600;
    }
    
    @media (max-width: 900px) {
      main {
        flex-direction: column;
      }
      #viz-wrap {
        width: 100%;
      }
    }
    
    pre {
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 12px;
    }
    
    /* Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© */
    .info-section {
      background-color: #f0f9f9;
      border-radius: 10px;
      padding: 15px;
      margin-top: 20px;
      border: 1px solid #c1e6e6;
      color: #005757;
    }
    
    .info-section h3 {
      margin-top: 0;
      color: #0e6666;
      font-size: 16px;
    }
    
    .info-section p {
      margin: 10px 0;
      font-size: 14px;
    }
    
    /* Ø±Ø§Ø¨Ø· Ø§Ù„Ø¹ÙˆØ¯Ø© */
    .back-link {
      display: inline-block;
      margin-top: 10px;
      color: #007b7b;
      text-decoration: none;
      font-weight: 600;
    }
    
    .back-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <!-- âœ… Ø§Ù„ØªÙˆØ¨ Ø¨Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
  <header>
    <img src="images/logo.PNG" alt="Ø´Ø¹Ø§Ø± Ø¨ÙŠÙ†">
    <h1>Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯Ù„Ø§Ù„ÙŠØ©</h1>
  </header>

  <div class="container">
    <!-- Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ -->
    <div class="page-header">
      <h1>Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø¯Ù„Ø§Ù„ÙŠ â€” <span class="field-name">...</span> âš¡</h1>
      <div class="controls">
        <button id="export-png">ğŸ–¼ï¸ ØªØµØ¯ÙŠØ± PNG</button>
        <button id="refresh-btn">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
      </div>
    </div>

    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <main>
      <section id="viz-wrap">
        <svg id="viz" preserveAspectRatio="xMidYMid meet"></svg>
      </section>
    </main>
    
    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© -->
    <div class="info-section">
      <h3>ğŸ’¡ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø¯Ù„Ø§Ù„ÙŠ</h3>
      <p>Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø¯Ù„Ø§Ù„ÙŠ Ù‡Ùˆ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ù† Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¯Ù„Ø§Ù„ÙŠÙ‹Ø§ ÙÙŠ Ù…Ø¬Ø§Ù„ Ù…Ø¹ÙŠÙ†. ÙƒÙ„ Ø¹Ù‚Ø¯Ø© ØªÙ…Ø«Ù„ Ù…ÙÙ‡ÙˆÙ…Ù‹Ø§ØŒ ÙˆÙƒÙ„ Ø±Ø§Ø¨Ø· ÙŠÙ…Ø«Ù„ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø© Ø¨ÙŠÙ† Ù…ÙÙ‡ÙˆÙ…ÙŠÙ†.</p>
      <p>Ø§Ù„Ø£Ù„ÙˆØ§Ù† ØªÙ…Ø«Ù„ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¹Ù‚Ø¯:
        <span style="color:#0b6cff;">â— Ù…Ø±ÙƒØ²ÙŠ</span>, 
        <span style="color:#ff6b6b;">â— Ø­Ø¯Ø«</span>, 
        <span style="color:#4ecdc4;">â— ÙØ§Ø¹Ù„</span>, 
        <span style="color:#ffd166;">â— Ø·Ø±ÙŠÙ‚Ø©</span>, 
        <span style="color:#9b5de5;">â— Ø¹Ø§Ø·ÙØ©</span>, 
        <span style="color:#f77f00;">â— Ù†ØªÙŠØ¬Ø©</span>
      </p>
      <a href="builder.html" class="back-link">â† Ø¥Ù†Ø´Ø§Ø¡ Ø­Ù‚Ù„ Ø¯Ù„Ø§Ù„ÙŠ Ø¬Ø¯ÙŠØ¯</a>
    </div>
  </div>

  <!-- âœ… Ø§Ù„ÙÙˆØªØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
  <footer>
    <a href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    <a href="about.html">Ø¹Ù† Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</a>
    <a href="builder.html">Ù…Ù†Ø´Ø¦ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯Ù„Ø§Ù„ÙŠØ©</a>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>

  <script>
(function(){
  const svg = d3.select('#viz');
  let width = Math.max(800, window.innerWidth * 0.8);
  let height = Math.max(600, window.innerHeight * 0.7);
  svg.attr('width', width).attr('height', height);

  const colorScale = d3.scaleOrdinal()
    .domain(['core','event','actor','method','emotion','result'])
    .range(['#0b6cff','#ff6b6b','#4ecdc4','#ffd166','#9b5de5','#f77f00']);

  const exportPngBtn = document.getElementById('export-png');
  const refreshBtn = document.getElementById('refresh-btn');

  let simulation = d3.forceSimulation()
    .force('link', d3.forceLink().id(d => d.id).distance(120).strength(0.8))
    .force('charge', d3.forceManyBody().strength(-120))
    .force('center', d3.forceCenter(width / 2, height / 2))
    .force('collide', d3.forceCollide().radius(d => (d.size || 12) + 6));

  async function loadData() {
    const params = new URLSearchParams(window.location.search);
    const id = params.get("i") || "1";
    
    // Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø© Ù„Ù„Ù…Ù„ÙØ§Øª JSON
    const possiblePaths = [
      `data/hqool/${id}.json`,
      `/data/hqool/${id}.json`,
      `./data/hqool/${id}.json`,
      `../data/hqool/${id}.json`
    ];
    
    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ù…Ø³Ø§Ø± Ù…Ø¹ÙŠÙ†
    async function tryLoad(path) {
      try {
        console.log(`Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù†: ${path}`);
        const response = await fetch(path);
        if (!response.ok) {
          throw new Error(`Ø®Ø·Ø£ HTTP: ${response.status}`);
        }
        const data = await response.json();
        console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ Ù…Ù†:', path);
        return data;
      } catch (error) {
        console.log(`ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† ${path}:`, error.message);
        return null;
      }
    }
    
    // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù…ÙƒÙ†Ø© Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨
    return new Promise(async (resolve, reject) => {
      for (const path of possiblePaths) {
        const data = await tryLoad(path);
        if (data) {
          resolve(data);
          return;
        }
      }
      
      // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ØŒ Ù†Ø¬Ø±Ø¨ ØªØ­Ù…ÙŠÙ„ Ù…Ø«Ø§Ù„
      try {
        console.log("Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ø«Ø§Ù„ Ø§ÙØªØ±Ø§Ø¶ÙŠ...");
        const exampleData = {
          fields: [{
            id: "1",
            title: "Ø­Ù‚Ù„ Ø§Ù„Ø«ÙˆØ±Ø© - Ù…Ø«Ø§Ù„",
            description: "Ù…Ø«Ø§Ù„ ØªÙˆØ¶ÙŠØ­ÙŠ Ù„Ù„Ø­Ù‚Ù„ Ø§Ù„Ø¯Ù„Ø§Ù„ÙŠ",
            nodes: [
              { id: "1", label: "Ø«ÙˆØ±Ø©", type: "core", size: 20 },
              { id: "2", label: "Ø­Ø±ÙŠØ©", type: "result", size: 16 },
              { id: "3", label: "ØªØºÙŠÙŠØ±", type: "result", size: 14 },
              { id: "4", label: "Ø§Ø­ØªØ¬Ø§Ø¬", type: "event", size: 12 },
              { id: "5", label: "Ø§Ù„Ø´Ø¹Ø¨", type: "actor", size: 16 },
              { id: "6", label: "ØºØ¶Ø¨", type: "emotion", size: 10 },
              { id: "7", label: "ØªØ¸Ø§Ù‡Ø±", type: "method", size: 12 }
            ],
            links: [
              { source: "1", target: "2", weight: 3 },
              { source: "1", target: "3", weight: 2 },
              { source: "1", target: "4", weight: 4 },
              { source: "4", target: "5", weight: 3 },
              { source: "5", target: "6", weight: 3 },
              { source: "4", target: "7", weight: 2 }
            ]
          }]
        };
        resolve(exampleData);
      } catch (error) {
        reject(new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø¬Ù„Ø¯ data/hqool Ù…Ø¹ Ù…Ù„ÙØ§Øª JSON.'));
      }
    });
  }

  // ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  loadData()
    .then(json => {
      console.log('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©:', json);
      
      // ØªØ­Ù‚Ù‚ Ù…Ù† Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      if (!json || typeof json !== 'object') {
        throw new Error('Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©: JSON ÙØ§Ø±Øº Ø£Ùˆ ØºÙŠØ± ØµØ­ÙŠØ­');
      }
      
      // Ø¥Ù…Ø§ Ø£Ù† ÙŠÙƒÙˆÙ† json Ù‡Ùˆ Ø§Ù„Ø­Ù‚Ù„ Ù…Ø¨Ø§Ø´Ø±Ø© Ø£Ùˆ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…ØµÙÙˆÙØ© fields
      let field;
      if (json.fields && Array.isArray(json.fields) && json.fields.length > 0) {
        field = json.fields[0];
      } else if (json.nodes && json.links) {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† json ÙŠØ­ØªÙˆÙŠ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù„Ù‰ nodes Ùˆ links
        field = json;
      } else {
        throw new Error('Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹. ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ nodes Ùˆ links Ø£Ùˆ Ù…ØµÙÙˆÙØ© fields.');
      }
      
      // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø©
      const fieldName = field.title || 'Ø­Ù‚Ù„ ØºÙŠØ± Ù…Ø¹Ù†ÙˆÙ†';
      d3.select('.field-name').text(fieldName);
      document.title = `Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯Ù„Ø§Ù„ÙŠØ© â€” ${fieldName}`;
      
      // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
      if (!field.nodes || !field.links || !Array.isArray(field.nodes) || !Array.isArray(field.links)) {
        throw new Error('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¹Ù‚Ø¯ Ø£Ùˆ Ø±ÙˆØ§Ø¨Ø· ØµØ§Ù„Ø­Ø©');
      }
      
      console.log(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${field.nodes.length} Ø¹Ù‚Ø¯Ø© Ùˆ ${field.links.length} Ø±Ø§Ø¨Ø·`);
      renderGraph(field);
      hookButtons(field);
    })
    .catch(error => {
      console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
      
      // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ ÙÙŠ SVG
      svg.selectAll('*').remove();
      
      const errorGroup = svg.append('g')
        .attr('transform', `translate(${width/2}, ${height/2})`);
      
      errorGroup.append('circle')
        .attr('r', 60)
        .attr('fill', '#ffeaea')
        .attr('stroke', '#ff6b6b')
        .attr('stroke-width', 2);
      
      errorGroup.append('text')
        .attr('y', -20)
        .attr('text-anchor', 'middle')
        .attr('dominant-baseline', 'middle')
        .attr('fill', '#ff6b6b')
        .attr('font-size', '20px')
        .text('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
      
      errorGroup.append('text')
        .attr('y', 10)
        .attr('text-anchor', 'middle')
        .attr('dominant-baseline', 'middle')
        .attr('fill', '#666')
        .attr('font-size', '14px')
        .text(error.message || 'ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
      
      errorGroup.append('text')
        .attr('y', 40)
        .attr('text-anchor', 'middle')
        .attr('dominant-baseline', 'middle')
        .attr('fill', '#888')
        .attr('font-size', '12px')
        .text('ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ù‚Ù„ Ø¯Ù„Ø§Ù„ÙŠ Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù†Ø´Ø¦ Ø§Ù„Ø­Ù‚ÙˆÙ„');
    });

  function renderGraph(field) {
    svg.selectAll('*').remove();
    const g = svg.append('g');

    // Ø±Ø³Ù… Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
    const link = g.append('g').selectAll('line')
      .data(field.links).enter().append('line')
      .attr('stroke','#aaa')
      .attr('stroke-width', d => Math.max(1, d.weight || 1))
      .attr('stroke-opacity', 0.7);

    // Ø±Ø³Ù… Ø§Ù„Ø¹Ù‚Ø¯
    const node = g.append('g').selectAll('g')
      .data(field.nodes).enter().append('g')
      .call(d3.drag()
        .on('start', (e,d)=>{
          if(!e.active) simulation.alphaTarget(0.3).restart();
          d.fx = d.x;
          d.fy = d.y;
        })
        .on('drag', (e,d)=>{
          d.fx = e.x;
          d.fy = e.y;
        })
        .on('end', (e,d)=>{
          if(!e.active) simulation.alphaTarget(0);
          d.fx = null;
          d.fy = null;
        })
      );

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆØ§Ø¦Ø±
    node.append('circle')
      .attr('r', d => d.size || 12)
      .attr('fill', d => colorScale(d.type))
      .attr('stroke','#fff')
      .attr('stroke-width', 2)
      .attr('stroke-opacity', 0.9);

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†ØµÙˆØµ
    node.append('text')
      .attr('dy', 4)
      .attr('text-anchor', 'middle')
      .attr('font-size', d => Math.max(10, Math.min(14, (d.size || 12) / 1.5)))
      .attr('fill', '#222')
      .attr('font-weight', '600')
      .text(d => d.label);

    // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙƒØ¨ÙŠØ± ÙˆØ§Ù„ØªØ­Ø±ÙŠÙƒ
    svg.call(d3.zoom()
      .scaleExtent([0.3, 3])
      .on('zoom', e => g.attr('transform', e.transform))
    );

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©
    simulation.nodes(field.nodes);
    simulation.force('link').links(field.links);
    
    simulation.on('tick', () => {
      link.attr('x1', d => d.source.x)
          .attr('y1', d => d.source.y)
          .attr('x2', d => d.target.x)
          .attr('y2', d => d.target.y);
      node.attr('transform', d => `translate(${d.x}, ${d.y})`);
    });

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©
    simulation.alpha(1).restart();
  }

  function hookButtons(field) {
    exportPngBtn.addEventListener('click', () => {
      exportToPNG(svg.node(), (field.id || 'field') + '.png');
    });
    
    refreshBtn.addEventListener('click', () => {
      location.reload();
    });
  }

  function exportToPNG(svgNode, filename) {
    const serializer = new XMLSerializer();
    let source = serializer.serializeToString(svgNode);
    
    // Ø¥Ø¶Ø§ÙØ© Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡ ÙˆØ¶Ù…Ø§Ù† Ø¹Ø±Ø¶ Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
    const parser = new DOMParser();
    const svgDoc = parser.parseFromString(source, 'image/svg+xml');
    const svgElement = svgDoc.documentElement;
    
    // Ø¥Ø¶Ø§ÙØ© Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡
    const rect = svgDoc.createElementNS('http://www.w3.org/2000/svg', 'rect');
    rect.setAttribute('width', '100%');
    rect.setAttribute('height', '100%');
    rect.setAttribute('fill', '#ffffff');
    svgElement.insertBefore(rect, svgElement.firstChild);
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØµØ¯Ø±
    source = serializer.serializeToString(svgDoc);
    
    const img = new Image();
    const svg64 = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(source);
    
    img.onload = function() {
      const canvas = document.createElement('canvas');
      canvas.width = svgNode.getBoundingClientRect().width;
      canvas.height = svgNode.getBoundingClientRect().height;
      const ctx = canvas.getContext('2d');
      
      // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø¨ÙŠØ¶
      ctx.fillStyle = '#fff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Ø±Ø³Ù… Ø§Ù„ØµÙˆØ±Ø©
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      
      // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ PNG ÙˆØªÙ†Ø²ÙŠÙ„
      canvas.toBlob(function(blob){
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 'image/png');
    };
    
    img.src = svg64;
  }

  window.addEventListener('resize', () => {
    width = Math.max(800, window.innerWidth * 0.8);
    height = Math.max(600, window.innerHeight * 0.7);
    svg.attr('width', width).attr('height', height);
    simulation.force('center', d3.forceCenter(width/2, height/2));
    simulation.alpha(0.3).restart();
  });

})();
  </script>

</body>
</html>
